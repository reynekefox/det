from typing import Dict
from docs_loader import DocsLoader
from m_config import logger

cached_prompts: Dict[str, str] = {}

def format_prompt_with_link(prompt: str) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç, –∑–∞–º–µ–Ω—è—è —Å—Å—ã–ª–∫—É –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç."""
    # –ó–∞–º–µ–Ω—è–µ–º markdown-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –æ–±—ã—á–Ω—É—é URL
    prompt = prompt.replace(
        "*\"–ö–∞–∫ –≤–¥–æ—Ö–Ω–æ–≤–∏—Ç—å —Ä–µ–±–µ–Ω–∫–∞ –Ω–∞ –ª—é–±–æ–≤—å –∫ —É—á–µ–±–µ\"* ‚Äî –æ–Ω –º–æ–∂–µ—Ç –ø—Ä–∏–≥–æ–¥–∏—Ç—å—Å—è, –µ—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –º–æ—Ç–∏–≤–∞—Ü–∏–µ–π:  \nüëâ [**–°–∫–∞—á–∞—Ç—å –≥–∞–π–¥**](https://mellow-fish-patx92z.gamma.site/)",
        "–ø–æ–ª–µ–∑–Ω—ã–π –≥–∞–π–¥ \"–ö–∞–∫ –≤–¥–æ—Ö–Ω–æ–≤–∏—Ç—å —Ä–µ–±–µ–Ω–∫–∞ –Ω–∞ –ª—é–±–æ–≤—å –∫ —É—á–µ–±–µ\" ‚Äî –æ–Ω –º–æ–∂–µ—Ç –ø—Ä–∏–≥–æ–¥–∏—Ç—å—Å—è, –µ—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –º–æ—Ç–∏–≤–∞—Ü–∏–µ–π: https://mellow-fish-patx92z.gamma.site/"
    )
    return prompt

def load_all_prompts(docs_loader_instance: DocsLoader) -> None:
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–º–ø—Ç –∏–∑ Google Docs."""
    global cached_prompts
    try:
        main_prompt = docs_loader_instance.get_document_content()
        cached_prompts["main"] = format_prompt_with_link(main_prompt)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏: {e}")
        cached_prompts["main"] = docs_loader_instance._get_default_prompt()

async def get_system_prompt_content(docs_loader_instance: DocsLoader) -> str:
    """–ü–æ–ª—É—á–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç."""
    if not cached_prompts.get("main"):
        try:
            main_prompt = docs_loader_instance.get_document_content()
            cached_prompts["main"] = format_prompt_with_link(main_prompt)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞: {e}")
            return "–¢—ã - –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª–µ–π. –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –≤–µ–∂–ª–∏–≤–æ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ."

    # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–≥–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø—Ä–æ—Ç–∏–≤ —Ñ–∞–Ω—Ç–∞–∑–∏—Ä–æ–≤–∞–Ω–∏—è
    strict_instructions = """

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –°–¢–†–û–ì–ò–ï –ü–†–ê–í–ò–õ–ê –û–¢–í–ï–¢–û–í:

1. –û–¢–í–ï–ß–ê–ô –¢–û–õ–¨–ö–û –ù–ê –û–°–ù–û–í–ï –ü–†–ï–î–û–°–¢–ê–í–õ–ï–ù–ù–û–ô –ò–ù–°–¢–†–£–ö–¶–ò–ò
2. –ù–ò–ö–û–ì–î–ê –ù–ï –ü–†–ò–î–£–ú–´–í–ê–ô –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ —Ç–≤–æ–µ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
3. –ï—Å–ª–∏ –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å - –ø—Ä—è–º–æ —Å–∫–∞–∂–∏: "–í –º–æ–µ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ —ç—Ç–æ–º—É –≤–æ–ø—Ä–æ—Å—É"
4. –ù–ï –î–û–î–£–ú–´–í–ê–ô –¥–µ—Ç–∞–ª–∏ –∏–ª–∏ —Ñ–∞–∫—Ç—ã
5. –ù–ï –°–°–´–õ–ê–ô–°–Ø –Ω–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∏–ª–∏ –º–µ—Ç–æ–¥–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
6. –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —Ç–µ –º–µ—Ç–æ–¥—ã –∏ –ø–æ–¥—Ö–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ–ø–∏—Å–∞–Ω—ã –≤ —Ç–≤–æ–µ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
7. –ù–ò–ö–û–ì–î–ê –ù–ï –ü–†–ò–î–£–ú–´–í–ê–ô –°–°–´–õ–ö–ò - –µ—Å–ª–∏ —Å—Å—ã–ª–∫–∏ –Ω–µ—Ç –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –Ω–µ —É–ø–æ–º–∏–Ω–∞–π –µ–µ –≤–æ–æ–±—â–µ
8. –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô –∑–∞–≥–ª—É—à–∫–∏ —Ç–∏–ø–∞ "[—Å—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–∏–º–µ—Ä]", "youtube.com/–∫–∞–Ω–∞–ª" –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö URL
9. –ù–ï –°–°–´–õ–ê–ô–°–Ø –Ω–∞ –≤–Ω–µ—à–Ω–∏–µ —Ä–µ—Å—É—Ä—Å—ã, –∫–∞–Ω–∞–ª—ã, —Å–∞–π—Ç—ã, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç —á—Ç–æ-—Ç–æ, –≤—ã—Ö–æ–¥—è—â–µ–µ –∑–∞ —Ä–∞–º–∫–∏ —Ç–≤–æ–µ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –æ—Ç–≤–µ—á–∞–π:
"–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–æ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ —Ä–∞–º–∫–∏ –º–æ–µ–π —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏. –†–µ–∫–æ–º–µ–Ω–¥—É—é –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –¥–µ—Ç—Å–∫–æ–º—É –ø—Å–∏—Ö–æ–ª–æ–≥—É –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É."
"""

    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —ç–º–æ—Ü–∏—è–º
    from emotion_handler import get_available_emotions
    emotion_instructions = f"""

–í–ê–ñ–ù–û: –í –∫–æ–Ω—Ü–µ –∫–∞–∂–¥–æ–≥–æ —Å–≤–æ–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –¥–æ–±–∞–≤–ª—è–π —Ç–µ–≥ —Å —ç–º–æ—Ü–∏–µ–π, –∫–æ—Ç–æ—Ä–∞—è –ª—É—á—à–µ –≤—Å–µ–≥–æ –ø–µ—Ä–µ–¥–∞–µ—Ç —Ç–æ–Ω —Ç–≤–æ–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:
[emotion:–Ω–∞–∑–≤–∞–Ω–∏–µ_—ç–º–æ—Ü–∏–∏]

–î–æ—Å—Ç—É–ø–Ω—ã–µ —ç–º–æ—Ü–∏–∏: {get_available_emotions()}

–í—ã–±–∏—Ä–∞–π —ç–º–æ—Ü–∏—é –∏—Å—Ö–æ–¥—è –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ —Ç–æ–Ω–∞ –æ—Ç–≤–µ—Ç–∞:
- —Ä–∞–¥–æ—Å—Ç—å - –¥–ª—è –ø–æ–∑–∏—Ç–∏–≤–Ω—ã—Ö, –≤–æ–æ–¥—É—à–µ–≤–ª—è—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- —Å–æ—á—É–≤—Å—Ç–≤–∏–µ - –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ç—Ä—É–¥–Ω–æ—Å—Ç–µ–π —Ä–æ–¥–∏—Ç–µ–ª–µ–π  
- —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å - –¥–ª—è —á–µ—Ç–∫–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –∏ —Å–æ–≤–µ—Ç–æ–≤
- –∑–∞–¥—É–º—á–∏–≤–æ—Å—Ç—å - –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö –∞–Ω–∞–ª–∏–∑–∞
- –ø–æ–¥–¥–µ—Ä–∂–∫–∞ - –¥–ª—è –æ–±–æ–¥—Ä–µ–Ω–∏—è –∏ –º–æ—Ç–∏–≤–∞—Ü–∏–∏
- —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ - –¥–ª—è —É—Å–ø–æ–∫–∞–∏–≤–∞—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –ø–æ–Ω–∏–º–∞–Ω–∏–µ - –¥–ª—è –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è —ç–º–ø–∞—Ç–∏–∏
- —ç–Ω—Ç—É–∑–∏–∞–∑–º - –¥–ª—è –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏—Ö —Å–æ–≤–µ—Ç–æ–≤

–ü—Ä–∏–º–µ—Ä: "–†–µ–∫–æ–º–µ–Ω–¥—É—é –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥... [emotion:—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å]"
"""

    return cached_prompts["main"] + strict_instructions + emotion_instructions